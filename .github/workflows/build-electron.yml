name: Build Meftah FinLit App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 🧩 Checkout repository
        uses: actions/checkout@v4

      - name: ⚙️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: 📦 Install global build tools
        run: |
          npm install -g npm@latest
          npm install -g electron electron-builder

      - name: 🧰 Install dependencies
        run: |
          if [ -d "frontend" ]; then
            cd frontend
            npm install
            npm run build || echo "⚠️ Frontend build skipped (no scripts)"
            cd ..
          fi
          npm install

      - name: 🏗️ Configure electron-builder
        run: |
          echo '{
            "appId": "com.meftah.finlit",
            "productName": "مفتاح | آموزش سواد مالی",
            "directories": {
              "output": "dist"
            },
            "files": [
              "**/*",
              "!node_modules/*/{CHANGELOG.md,README.md,README,readme.md,readme}",
              "!**/node_modules/*/{test,__tests__,tests,powered-test,example,examples}"
            ],
            "win": {
              "target": ["nsis"],
              "icon": "مفتاح - بدون زمینه.png",
              "publisherName": "Meftah Education"
            },
            "nsis": {
              "oneClick": false,
              "allowToChangeInstallationDirectory": true,
              "createDesktopShortcut": true,
              "createStartMenuShortcut": true,
              "shortcutName": "مفتاح"
            },
            "mac": {
              "target": ["dmg"],
              "icon": "مفتاح - بدون زمینه.png"
            },
            "linux": {
              "target": ["AppImage"],
              "icon": "مفتاح - بدون زمینه.png"
            }
          }' > electron-builder.json

      - name: 🚀 Build Electron App
        run: |
          npx electron-builder --config electron-builder.json || true

      - name: 📤 Upload Installers
        uses: actions/upload-artifact@v4
        with:
          name: Meftah-FinLit-Installers
          path: dist/
